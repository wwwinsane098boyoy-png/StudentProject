<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Flow - StudentProject</title>
    <!-- Chart.js for the graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html { background-color: var(--bg-primary); height: 100%; }
        :root {
            --bg-primary: #0a0a0a; --bg-secondary: #1a1a1a; --bg-tertiary: #202020; --bg-card: #252525;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-tertiary: #707070;
            --accent-primary: #6366f1; --accent-secondary: #818cf8; --accent-glow: #6366f140;
            --border: #303030; --shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }
        .container { max-width: 1400px; width: 100%; margin: 0 auto; padding: 2rem; flex: 1; }
        .header { text-align: center; margin-bottom: 3rem; animation: fadeInDown 0.6s ease; }
        .brand-row { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 1rem; }
        .app-title { font-size: 1rem; font-weight: 500; color: var(--accent-secondary); text-transform: uppercase; letter-spacing: 3px; }
        .brand-divider { width: 1px; height: 14px; background-color: rgba(255, 255, 255, 0.2); }
        .parent-logo { font-size: 0.85rem; font-weight: 400; text-transform: uppercase; letter-spacing: 2px; text-decoration: none; color: rgba(255, 255, 255, 0.4); transition: color 0.3s ease; }
        .parent-logo:hover { color: rgba(255, 255, 255, 0.8); cursor: pointer; }
        .clock { font-size: 4rem; font-weight: 200; background: linear-gradient(135deg, var(--text-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; position: relative; }
        .clock::after { content: attr(data-date); position: absolute; bottom: -1.5rem; left: 50%; transform: translateX(-50%); font-size: 0.9rem; font-weight: 400; color: var(--text-secondary); -webkit-text-fill-color: var(--text-secondary); white-space: nowrap; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .card { background: var(--bg-tertiary); border-radius: 20px; padding: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border); animation: fadeInUp 0.6s ease; }
        .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-primary); }
        .timer-section { display: flex; flex-direction: column; align-items: center; }
        .timer-display { position: relative; width: 280px; height: 280px; margin-bottom: 2rem; }
        .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .timer-background { fill: none; stroke: var(--bg-card); stroke-width: 12; }
        .timer-progress { fill: none; stroke: var(--accent-primary); stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 0.1s linear; filter: drop-shadow(0 0 10px var(--accent-glow)); }
        .timer-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .timer-countdown { font-size: 3rem; font-weight: 300; letter-spacing: -1px; }
        .timer-label { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .timer-inputs { display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: center; flex-wrap: wrap; }
        .time-input-group { display: flex; flex-direction: column; align-items: center; }
        .time-input { width: 70px; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); text-align: center; font-size: 1.2rem; font-weight: 500; transition: all 0.3s ease; }
        .time-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-glow); }
        .time-input-label { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem; text-transform: uppercase; }
        .timer-controls { display: flex; gap: 1rem; width: 100%; justify-content: center; }
        .btn { padding: 0.75rem 2rem; border: none; border-radius: 12px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; flex: 1; max-width: 200px; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--accent-primary); color: white; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .task-input { width: 100%; padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: 1rem; }
        .current-task-display { background: var(--bg-card); border-radius: 12px; padding: 1.5rem; margin-top: 1rem; border: 1px solid var(--border); border-left: 4px solid var(--accent-primary); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 2rem; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 1.2rem; text-align: center; border: 1px solid var(--border); }
        .stat-value { font-size: 1.8rem; font-weight: 600; color: var(--accent-primary); }
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 1rem; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .notification { position: fixed; top: 2rem; right: 2rem; background: var(--bg-card); border: 1px solid var(--accent-primary); border-radius: 12px; padding: 1rem 1.5rem; display: none; align-items: center; gap: 1rem; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .notification.show { display: flex; }
        .notification-icon { width: 24px; height: 24px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        @media screen and (max-width: 1024px) { .container { padding: 1.5rem; } .main-content { grid-template-columns: 1fr; } .progress-section { grid-column: span 1; } }
        @media screen and (max-width: 600px) { .brand-row { gap: 10px; } .timer-display { width: 240px; height: 240px; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    
    <!-- AUTH BRIDGE -->
    <script>
        // Security: Ensure user is logged in
        const currentUser = localStorage.getItem("currentUser");
        if (!currentUser) { window.location.href = "/"; }
    </script>

    <header class="header">
        <div class="container">
            <div class="brand-row">
                <div class="app-title">Focus Flow</div>
                <div class="brand-divider"></div>
                <!-- Link back to Main Dashboard -->
                <a href="{{ url_for('home') }}" class="parent-logo">Cresco </a>
            </div>
            <div class="clock" id="clock" data-date="">00:00:00</div>
        </div>
    </header>

    <main class="container">
        <div class="main-content">
            <!-- Focus Timer -->
            <div class="card">
                <h2 class="card-title">Focus Timer</h2>
                <div class="timer-section">
                    <div class="timer-display">
                        <svg class="timer-svg">
                            <circle class="timer-background" cx="140" cy="140" r="130"></circle>
                            <circle class="timer-progress" id="timerProgress" cx="140" cy="140" r="130"></circle>
                        </svg>
                        <div class="timer-text">
                            <div class="timer-countdown" id="timerCountdown">00:00:00</div>
                            <div class="timer-label" id="timerStatus">Ready to focus</div>
                        </div>
                    </div>

                    <div class="timer-inputs">
                        <div class="time-input-group">
                            <input type="number" class="time-input" id="hoursInput" min="0" max="23" value="0"><span class="time-input-label">Hours</span>
                        </div>
                        <div class="time-input-group">
                            <input type="number" class="time-input" id="minutesInput" min="0" max="59" value="25"><span class="time-input-label">Minutes</span>
                        </div>
                        <div class="time-input-group">
                            <input type="number" class="time-input" id="secondsInput" min="0" max="59" value="0"><span class="time-input-label">Seconds</span>
                        </div>
                    </div>

                    <div class="timer-controls">
                        <button class="btn btn-primary" id="startBtn"><span>Start Focus</span></button>
                        <button class="btn btn-secondary" id="pauseBtn"><span>Pause</span></button>
                        <button class="btn btn-secondary" id="resetBtn"><span>Reset</span></button>
                    </div>
                </div>
            </div>

            <!-- Task Management -->
            <div class="card">
                <h2 class="card-title">Task Management</h2>
                <div class="task-section">
                    <div class="task-input-group">
                        <input type="text" class="task-input" id="taskInput" placeholder="What are you working on?">
                        <button class="btn btn-primary" id="updateTaskBtn" style="width: 100%; margin-top: 1rem;"><span>Update Task</span></button>
                    </div>
                    <div class="current-task-display">
                        <div class="current-task-label">Current Task</div>
                        <div class="current-task-text" id="currentTask">No task set</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="todayTime">0h</div><div class="stat-label">Today's Focus</div></div>
                        <div class="stat-card"><div class="stat-value" id="totalSessions">0</div><div class="stat-label">Sessions</div></div>
                        <div class="stat-card"><div class="stat-value" id="streak">0</div><div class="stat-label">Day Streak</div></div>
                    </div>
                </div>
            </div>

            <!-- Progress Analytics -->
            <div class="card progress-section">
                <h2 class="card-title">Daily Study Progress</h2>
                <div class="chart-container"><canvas id="progressChart"></canvas></div>
            </div>
        </div>
    </main>

    <div class="notification" id="notification">
        <div class="notification-icon">âœ“</div>
        <div><div style="font-weight: 600;">Focus Session Complete!</div><div style="font-size: 0.9rem; color: var(--text-secondary);">Great work! Time for a break.</div></div>
    </div>

    <!-- JAVASCRIPT (MULTI-USER SUPPORT) -->
<script>
    // --- KEYS ---
    const user = localStorage.getItem("currentUser") || "guest";
    const KEY_STUDY_DATA = user + "_studyData";
    const KEY_CURRENT_TASK = user + "_currentTask";

    let timerInterval = null;
    let totalSeconds = 0;
    let remainingSeconds = 0;
    let isPaused = false;
    let isRunning = false;
    let currentTask = '';
    let studyData = {};
    let chart = null;

    // Elements
    const clockElement = document.getElementById('clock');
    const timerCountdown = document.getElementById('timerCountdown');
    const timerProgress = document.getElementById('timerProgress');
    const timerStatus = document.getElementById('timerStatus');
    const hoursInput = document.getElementById('hoursInput');
    const minutesInput = document.getElementById('minutesInput');
    const secondsInput = document.getElementById('secondsInput');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const taskInput = document.getElementById('taskInput');
    const updateTaskBtn = document.getElementById('updateTaskBtn');
    const currentTaskDisplay = document.getElementById('currentTask');
    const todayTimeDisplay = document.getElementById('todayTime');
    const totalSessionsDisplay = document.getElementById('totalSessions');
    const streakDisplay = document.getElementById('streak');
    const notification = document.getElementById('notification');

    document.addEventListener('DOMContentLoaded', () => {
        initializeClock();
        loadData();
        initializeChart();
        updateStats();
        setupEventListeners();
        setupTimerCircle();
    });

    // --- HELPER: CONSISTENT DATE KEY (YYYY-MM-DD) ---
    // This fixes the bug where data disappears because of timezones
    function getLocalKey(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function initializeClock() { updateClock(); setInterval(updateClock, 1000); }
    function updateClock() {
        const now = new Date();
        clockElement.textContent = now.toLocaleTimeString('en-US', {hour12: false});
        clockElement.setAttribute('data-date', now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
    }

    function setupTimerCircle() {
        const circumference = 2 * Math.PI * 130;
        timerProgress.style.strokeDasharray = circumference;
        timerProgress.style.strokeDashoffset = circumference;
    }

    function startTimer() {
        if (isRunning && !isPaused) return;
        if (!isPaused) {
            const h = parseInt(hoursInput.value)||0, m = parseInt(minutesInput.value)||0, s = parseInt(secondsInput.value)||0;
            totalSeconds = h * 3600 + m * 60 + s;
            remainingSeconds = totalSeconds;
            if (totalSeconds === 0) return alert('Please set a duration');
        }
        isRunning = true; isPaused = false;
        timerStatus.textContent = 'Focus mode active';
        startBtn.innerHTML = '<span>Focusing...</span>'; startBtn.disabled = true;
        timerInterval = setInterval(() => {
            if (remainingSeconds > 0) { remainingSeconds--; updateTimerDisplay(); updateProgress(); }
            else completeTimer();
        }, 1000);
    }

    function pauseTimer() {
        if (!isRunning || isPaused) return;
        clearInterval(timerInterval); isPaused = true; isRunning = false;
        timerStatus.textContent = 'Paused'; startBtn.innerHTML = '<span>Resume</span>'; startBtn.disabled = false;
    }

    function resetTimer() {
        clearInterval(timerInterval); isRunning = false; isPaused = false; remainingSeconds = 0; totalSeconds = 0;
        updateTimerDisplay(); updateProgress();
        timerStatus.textContent = 'Ready to focus'; startBtn.innerHTML = '<span>Start Focus</span>'; startBtn.disabled = false;
    }

    function completeTimer() {
        clearInterval(timerInterval); isRunning = false; isPaused = false;
        // Save the minutes worked
        const minutesWorked = Math.ceil(totalSeconds / 60); 
        saveStudyTime(minutesWorked);
        
        timerStatus.textContent = 'Session complete!'; startBtn.innerHTML = '<span>Start Focus</span>'; startBtn.disabled = false;
        showNotification(); playNotificationSound();
        setTimeout(resetTimer, 3000);
    }

    function updateTimerDisplay() {
        const h = Math.floor(remainingSeconds / 3600), m = Math.floor((remainingSeconds%3600)/60), s = remainingSeconds%60;
        timerCountdown.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    function updateProgress() {
        if(totalSeconds === 0) { timerProgress.style.strokeDashoffset = 2 * Math.PI * 130; return; }
        const circumference = 2 * Math.PI * 130;
        const progress = remainingSeconds / totalSeconds;
        timerProgress.style.strokeDashoffset = circumference * (1 - progress);
    }

    function updateTask() {
        const task = taskInput.value.trim();
        if (task) {
            currentTask = task; currentTaskDisplay.textContent = task;
            localStorage.setItem(KEY_CURRENT_TASK, task); taskInput.value = '';
        }
    }

    // --- DATA HANDLING ---
    function loadData() {
        const savedData = localStorage.getItem(KEY_STUDY_DATA);
        if (savedData) {
            studyData = JSON.parse(savedData);
        } else {
            studyData = {}; 
        }
        const savedTask = localStorage.getItem(KEY_CURRENT_TASK);
        if (savedTask) { currentTask = savedTask; currentTaskDisplay.textContent = savedTask; }
    }

    function saveStudyTime(minutes) {
        const todayKey = getLocalKey(new Date());
        
        if (!studyData[todayKey]) {
            studyData[todayKey] = { minutes: 0, sessions: 0 };
        }
        
        studyData[todayKey].minutes += minutes;
        studyData[todayKey].sessions += 1;
        
        localStorage.setItem(KEY_STUDY_DATA, JSON.stringify(studyData));
        updateStats(); 
        updateChart();
    }

    function updateStats() {
        const todayKey = getLocalKey(new Date());
        const todayData = studyData[todayKey] || { minutes: 0, sessions: 0 };
        
        const h = Math.floor(todayData.minutes/60), m = todayData.minutes%60;
        todayTimeDisplay.textContent = h>0 ? `${h}h ${m}m` : `${m}m`;
        totalSessionsDisplay.textContent = todayData.sessions;
        
        // Streak Calc
        let streak = 0;
        const d = new Date();
        for (let i = 0; i < 365; i++) {
            const checkDate = new Date();
            checkDate.setDate(d.getDate() - i);
            const key = getLocalKey(checkDate);
            
            if (studyData[key] && studyData[key].minutes > 0) {
                streak++;
            } else if (i > 0) {
                // Break streak if we miss a day (except today, if we haven't started yet)
                // Logic: If yesterday missing, streak over.
                break;
            }
        }
        streakDisplay.textContent = streak;
    }

    // --- CHART LOGIC ---
    function initializeChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        const chartData = getChartData();
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [{ 
                    label: 'Study Time (minutes)', 
                    data: chartData.data, 
                    backgroundColor: '#6366f1', 
                    borderRadius: 4 
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        grid: { color: '#303030' }, 
                        ticks: { color: '#707070' } 
                    }, 
                    x: { 
                        grid: { display: false }, 
                        ticks: { color: '#707070' } 
                    } 
                } 
            }
        });
    }

    function getChartData() {
        const labels = [];
        const data = [];
        
        // Get last 7 days
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            
            const key = getLocalKey(d); // Matches saveStudyTime key exactly
            const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
            
            labels.push(dayName);
            
            // Check if data exists for this key
            if (studyData[key]) {
                data.push(studyData[key].minutes);
            } else {
                data.push(0);
            }
        }
        return { labels, data };
    }

    function updateChart() {
        if (!chart) return;
        const chartData = getChartData();
        chart.data.labels = chartData.labels;
        chart.data.datasets[0].data = chartData.data;
        chart.update();
    }

    function showNotification() {
        notification.classList.add('show');
        setTimeout(() => { notification.classList.remove('show'); }, 5000);
    }

    function playNotificationSound() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 800; oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + 0.5);
    }

    function setupEventListeners() {
        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', resetTimer);
        updateTaskBtn.addEventListener('click', updateTask);
        taskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') updateTask(); });
        
        [hoursInput, minutesInput, secondsInput].forEach(input => {
            input.addEventListener('input', (e) => {
                const max = parseInt(e.target.max), min = parseInt(e.target.min);
                let value = parseInt(e.target.value);
                if (value > max) e.target.value = max; if (value < min) e.target.value = min;
            });
        });
    }
</script>
</body>
</html>