<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SpendSense | Expense Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts & Charts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- CSS (EMBEDDED TO FIX LOADING ISSUES) -->
  <style>
    :root {
      --bg-body: #020617;
      --bg-card: rgba(15, 23, 42, 0.96);
      --bg-card-soft: rgba(15, 23, 42, 0.8);
      --border-subtle: rgba(148, 163, 184, 0.25);
      --accent: #6366f1;
      --accent-soft: rgba(129, 140, 248, 0.12);
      --accent-strong: #4f46e5;
      --accent-secondary: #22d3ee;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --radius-lg: 18px;
      --radius-md: 12px;
      --transition-fast: 150ms ease-out;
      --shadow-soft: 0 24px 55px rgba(15, 23, 42, 0.9);
      --shadow-card: 0 18px 40px rgba(15, 23, 42, 0.85);
    }

    *, *::before, *::after { box-sizing: border-box; }
    
    body {
      margin: 0; min-height: 100vh; font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top left, #1f2937, #020617 60%);
      color: var(--text-main); -webkit-font-smoothing: antialiased;
    }

    h1, h2, h3 { margin: 0; font-weight: 600; }
    p { margin: 0; }

    .app-shell { max-width: 1200px; margin: 0 auto; padding: 24px 16px 32px; overflow: hidden; }

    /* Top bar */
    .top-bar { display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 24px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-icon { width: 42px; height: 42px; border-radius: 999px; background: radial-gradient(circle at 30% 20%, #38bdf8, #4f46e5 60%, #0ea5e9); display: flex; align-items: center; justify-content: center; font-weight: 700; color: #f9fafb; box-shadow: 0 18px 40px rgba(56, 189, 248, 0.75); }
    .brand h1 { font-size: 1.35rem; }
    .brand p { font-size: 0.85rem; color: var(--text-muted); }
    .top-bar-actions { display: flex; gap: 8px; align-items: center; }

    .pill { padding: 6px 14px; font-size: 0.75rem; border-radius: 999px; border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px; color: var(--text-muted); background: transparent; cursor: default; text-decoration: none; }
    .pill-soft { background: rgba(15, 23, 42, 0.8); border-color: var(--border-subtle); cursor: pointer; transition: 0.2s; }
    .pill-soft:hover { background: rgba(30, 40, 60, 0.9); color: white; }
    .pill-outline { border-color: rgba(56, 189, 248, 0.4); color: #67e8f9; }

    /* View Switcher */
    .view-switcher { display: inline-flex; padding: 4px; border-radius: 999px; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(148, 163, 184, 0.3); margin-bottom: 12px; }
    .view-btn { border: none; background: transparent; color: var(--text-muted); font-size: 0.8rem; padding: 6px 14px; border-radius: 999px; cursor: pointer; transition: var(--transition-fast); }
    .view-btn.active { background: linear-gradient(135deg, #4f46e5, #22d3ee); color: #f9fafb; transform: translateY(-1px); box-shadow: 0 10px 22px rgba(56, 189, 248, 0.6); }
    .view { display: none; } .view.active { display: block; }

    /* Layout */
    .main-content { display: flex; flex-direction: column; gap: 18px; }
    .grid { display: grid; } .grid-2 { grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr); } .gap-lg { gap: 18px; }

    /* Cards */
    .card { position: relative; background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.14), transparent 45%), var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); padding: 18px 18px 16px; box-shadow: var(--shadow-card); backdrop-filter: blur(18px); transition: var(--transition-fast); }
    .card:hover { border-color: rgba(129, 140, 248, 0.7); box-shadow: var(--shadow-soft); transform: translateY(-2px); }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
    .card-header h2 { font-size: 1.05rem; } .card-header p { font-size: 0.8rem; color: var(--text-muted); }

    /* Current Title Card */
    .current-title-card { display: flex; justify-content: space-between; align-items: center; }
    .current-month-badge { padding: 6px 12px; border-radius: 999px; font-size: 0.8rem; border: 1px solid rgba(129, 140, 248, 0.6); background: linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(15, 23, 42, 0.98)); color: #c7d2fe; }

    /* Form */
    .form { display: flex; flex-direction: column; gap: 10px; margin-top: 4px; }
    .form-row { display: flex; gap: 10px; } .form-row.align-end { align-items: flex-end; }
    .form-group { flex: 1; display: flex; flex-direction: column; gap: 4px; } .form-group.full { flex: 1 1 100%; }
    label { font-size: 0.8rem; color: var(--text-muted); }
    input, select { font-family: inherit; font-size: 0.85rem; padding: 7px 9px; border-radius: 9px; border: 1px solid rgba(75, 85, 99, 0.65); background: rgba(15, 23, 42, 0.9); color: var(--text-main); outline: none; transition: var(--transition-fast); }
    input::placeholder { color: #4b5563; }
    input:focus, select:focus { border-color: rgba(129, 140, 248, 0.9); box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.7); transform: translateY(-1px); background: rgba(15, 23, 42, 0.95); }
    select { cursor: pointer; }

    .input-with-prefix { display: flex; align-items: center; gap: 4px; background: rgba(15, 23, 42, 0.9); border-radius: 9px; border: 1px solid rgba(75, 85, 99, 0.65); padding: 0 7px; transition: var(--transition-fast); }
    .input-with-prefix span { font-size: 0.8rem; color: #9ca3af; }
    .input-with-prefix input { border: none; padding-left: 2px; background: transparent; }
    .input-with-prefix:focus-within { border-color: rgba(129, 140, 248, 0.9); box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.7); transform: translateY(-1px); }

    .btn-primary { border: none; border-radius: 999px; padding: 9px 18px; background: linear-gradient(135deg, #4f46e5, #22d3ee); color: white; font-weight: 500; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 14px 30px rgba(56, 189, 248, 0.65); transition: var(--transition-fast); }
    .btn-primary:hover { transform: translateY(-1px); filter: brightness(1.05); box-shadow: 0 18px 36px rgba(56, 189, 248, 0.75); }
    .btn-primary:active { transform: translateY(1px) scale(0.99); box-shadow: 0 10px 20px rgba(15, 23, 42, 0.9); }
    .form-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex: 0 0 auto; }
    .form-error { font-size: 0.75rem; color: var(--danger); min-height: 14px; }

    /* Chart & Overview */
    .chart-wrapper { margin-top: 12px; position: relative; height: 260px; border-radius: var(--radius-md); background: var(--bg-card-soft); border: 1px solid rgba(148, 163, 184, 0.15); padding: 8px 8px 6px; }
    .chart-wrapper.small { height: 200px; }
    .chart-wrapper:hover { border-color: rgba(129, 140, 248, 0.7); }
    .chart-empty { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--text-muted); text-align: center; padding: 0 12px; }
    .month-overview-header h2 { font-size: 1.05rem; } .month-overview-header p { font-size: 0.8rem; color: var(--text-muted); }
    .month-total-display { margin-top: 6px; display: flex; flex-direction: column; gap: 2px; }
    .month-total-label { font-size: 0.8rem; color: var(--text-muted); }
    .month-total-value { font-size: 1.8rem; font-weight: 600; }

    /* Table */
    .table-wrapper { margin-top: 8px; border-radius: var(--radius-md); border: 1px solid rgba(148, 163, 184, 0.2); overflow: hidden; background: rgba(15, 23, 42, 0.8); }
    .month-table-scroll { max-height: 260px; overflow-y: auto; }
    .expense-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .expense-table thead { background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(17, 24, 39, 0.98)); }
    .expense-table th, .expense-table td { padding: 9px 12px; border-bottom: 1px solid rgba(31, 41, 55, 0.9); }
    .expense-table th { text-align: left; font-weight: 500; font-size: 0.8rem; color: var(--text-muted); }
    .expense-table tbody tr { transition: var(--transition-fast); }
    .expense-table tbody tr:hover { background: rgba(17, 24, 39, 0.98); transform: translateY(-1px); box-shadow: 0 6px 18px rgba(15, 23, 42, 0.9); }
    .text-right { text-align: right; }
    .expense-note { display: block; font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .amount-cell { font-weight: 600; }

    /* Pills */
    .category-pill { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 500; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(148, 163, 184, 0.3); }
    .category-food { border-color: rgba(34, 197, 94, 0.6); color: #bbf7d0; background: linear-gradient(135deg, rgba(22, 163, 74, 0.25), rgba(15, 23, 42, 0.95)); }
    .category-rent { border-color: rgba(59, 130, 246, 0.7); color: #bfdbfe; background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(15, 23, 42, 0.95)); }
    .category-transport { border-color: rgba(245, 158, 11, 0.8); color: #fed7aa; background: linear-gradient(135deg, rgba(251, 191, 36, 0.18), rgba(15, 23, 42, 0.95)); }
    .category-bills { border-color: rgba(94, 234, 212, 0.8); color: #a5f3fc; background: linear-gradient(135deg, rgba(45, 212, 191, 0.22), rgba(15, 23, 42, 0.95)); }
    .category-shopping { border-color: rgba(249, 115, 22, 0.8); color: #fed7aa; background: linear-gradient(135deg, rgba(248, 153, 42, 0.23), rgba(15, 23, 42, 0.95)); }
    .category-other { border-color: rgba(148, 163, 184, 0.7); color: #e5e7eb; }

    /* Year View */
    .year-summary-card { margin-top: 4px; }
    .year-summary-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 16px; margin-top: 8px; }
    .summary-label { font-size: 0.8rem; color: var(--text-muted); }
    .summary-value { margin-top: 4px; font-size: 1.25rem; font-weight: 600; }
    .year-grid { margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .month-card { padding: 14px 14px 12px; }
    .month-card-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 4px; }
    .month-chip { font-size: 0.78rem; padding: 3px 8px; border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.4); color: #e5e7eb; }
    .month-status { font-size: 0.72rem; color: var(--text-muted); }
    .month-card-total { margin-top: 4px; font-size: 1.1rem; font-weight: 600; }
    .month-card-sub { font-size: 0.78rem; color: var(--text-muted); margin-bottom: 4px; }

    /* Responsive */
    @media (max-width: 960px) { .grid-2 { grid-template-columns: minmax(0, 1fr); } .year-summary-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 720px) { .app-shell { padding: 20px 12px 28px; } .top-bar { flex-direction: column; align-items: flex-start; } .year-summary-grid { grid-template-columns: minmax(0, 1fr); } .form-row { flex-direction: column; } .table-wrapper { overflow-x: auto; } }
    @media (max-width: 480px) { .brand h1 { font-size: 1.15rem; } .card { padding: 14px 12px 12px; } }
  </style>
</head>
<body>
  
  <!-- AUTH BRIDGE -->
  <script>
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) { window.location.href = "/"; }
  </script>

  <div class="app-shell">
    <!-- Top bar -->
    <header class="top-bar">
      <div class="brand">
        <div class="brand-icon">₹</div>
        <div>
          <h1>SpendSense</h1>
          <p>Track your wealth</p>
        </div>
      </div>
      <div class="top-bar-actions">
        <!-- Back to Dashboard Link -->
        <a href="{{ url_for('home') }}" class="pill pill-soft">Back to Home</a>
        <button class="pill pill-outline">2025 • INR</button>
      </div>
    </header>

    <!-- View switcher -->
    <div class="view-switcher">
      <button class="view-btn active" data-view="current">Current Month</button>
      <button class="view-btn" data-view="year">Year Overview (12 Months)</button>
    </div>

    <main class="main-content">
      <!-- CURRENT MONTH VIEW -->
      <section id="view-current" class="view active">
        <!-- Title card -->
        <section class="card current-title-card">
          <div><h2>Current Month</h2></div>
          <div class="current-month-badge" id="current-month-label"></div>
        </section>

        <!-- Form + This month overview -->
        <section class="grid grid-2 gap-lg current-main">
          <!-- Add expense form (left) -->
          <div class="card form-card">
            <div class="card-header"><div><h2>Add Expense</h2></div></div>
            <form id="expense-form" class="form">
              <div class="form-row">
                <div class="form-group"><label for="date">Date</label><input type="date" id="date" required /></div>
                <div class="form-group">
                  <label for="category">Category</label>
                  <select id="category" required>
                    <option value="Food">Food &amp; Groceries</option>
                    <option value="Rent">Rent &amp; Housing</option>
                    <option value="Transport">Transport</option>
                    <option value="Bills">Bills &amp; Utilities</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group full"><label for="description">Note (optional)</label><input type="text" id="description" maxlength="80" placeholder="e.g. Groceries at local market" /></div>
              </div>
              <div class="form-row align-end">
                <div class="form-group">
                  <label for="amount">Amount</label>
                  <div class="input-with-prefix"><span>₹</span><input type="number" id="amount" min="0.01" step="0.01" placeholder="0.00" required /></div>
                </div>
                <div class="form-actions">
                  <p class="form-error" id="form-error"></p>
                  <button type="submit" class="btn-primary">Add Expense</button>
                </div>
              </div>
            </form>
          </div>

          <!-- This month overview (right) -->
          <div class="card month-overview-card">
            <div class="month-overview-header"><h2>This Month Overview</h2><p>Spending distribution by category.</p></div>
            <div class="month-total-display"><span class="month-total-label">Total This Month</span><span class="month-total-value" id="current-month-total-big">₹0.00</span></div>
            <div class="chart-wrapper">
              <canvas id="currentMonthPie"></canvas>
              <div class="chart-empty" id="current-month-empty">No expenses yet this month.</div>
            </div>
          </div>
        </section>

        <!-- This month detailed table -->
        <section class="card current-table-card">
          <div class="card-header"><div><h2>This Month Expenses</h2><p id="current-month-table-subtitle">No expenses yet.</p></div></div>
          <div class="table-wrapper month-table-scroll">
            <table class="expense-table">
              <thead><tr><th>Date &amp; Note</th><th>Category</th><th class="text-right">Amount (₹)</th></tr></thead>
              <tbody id="current-month-tbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- YEAR OVERVIEW VIEW -->
      <section id="view-year" class="view">
        <section class="card year-summary-card">
          <div class="card-header"><div><h2>Year Overview</h2><p id="year-summary-subtitle">Distribution across all months.</p></div></div>
          <div class="year-summary-grid">
            <div><div class="summary-label">Total This Year</div><div class="summary-value" id="year-total-amount">₹0.00</div></div>
            <div><div class="summary-label">Months With Expenses</div><div class="summary-value" id="year-months-count">0</div></div>
            <div><div class="summary-label">Average / Active Month</div><div class="summary-value" id="year-avg-month">₹0.00</div></div>
          </div>
        </section>
        <section id="year-months-container" class="year-grid"></section>
      </section>
    </main>
  </div>

  <!-- JAVASCRIPT (EMBEDDED) -->
  <script>
    // --- USER SPECIFIC KEY ---
    const user = localStorage.getItem("currentUser") || "guest";
    const STORAGE_KEY = user + "_expense-tracker-full-v1";

    const NOW = new Date();
    const CURRENT_YEAR = NOW.getFullYear();
    const CURRENT_MONTH_INDEX = NOW.getMonth();

    const CATEGORIES = ["Food", "Rent", "Transport", "Bills", "Shopping", "Other"];
    const CATEGORY_COLORS = { Food: "rgba(34, 197, 94, 0.9)", Rent: "rgba(99, 102, 241, 0.9)", Transport: "rgba(249, 115, 22, 0.9)", Bills: "rgba(45, 212, 191, 0.9)", Shopping: "rgba(236, 72, 153, 0.9)", Other: "rgba(148, 163, 184, 0.9)" };

    let expenses = [];
    let currentMonthPieChart = null;
    let monthPieCharts = new Array(12).fill(null);
    let yearViewBuilt = false;

    document.addEventListener("DOMContentLoaded", () => {
      initDateField(); loadExpenses(); initForm(); initViewSwitcher(); refreshUI();
    });

    function initDateField() {
      const dateInput = document.getElementById("date"); if (!dateInput) return;
      const today = new Date(); const isoToday = today.toISOString().slice(0, 10);
      const firstOfYear = new Date(CURRENT_YEAR, 0, 1).toISOString().slice(0, 10);
      dateInput.value = isoToday; dateInput.min = firstOfYear; dateInput.max = isoToday;
    }

    function loadExpenses() {
      try { const raw = localStorage.getItem(STORAGE_KEY); expenses = raw ? JSON.parse(raw) : []; }
      catch (e) { expenses = []; }
    }
    function saveExpenses() { localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses)); }

    function initForm() {
      const form = document.getElementById("expense-form"); const errorEl = document.getElementById("form-error");
      if (!form) return;
      form.addEventListener("submit", (e) => {
        e.preventDefault(); errorEl.textContent = "";
        const dateValue = document.getElementById("date").value;
        const category = document.getElementById("category").value;
        const description = document.getElementById("description").value.trim();
        const amountValue = document.getElementById("amount").value;

        if (!dateValue) { errorEl.textContent = "Please select a date."; return; }
        const selectedDate = new Date(dateValue + "T00:00:00");
        if (selectedDate.getFullYear() !== CURRENT_YEAR) { errorEl.textContent = `Please choose a date in ${CURRENT_YEAR}.`; return; }
        if (selectedDate > new Date()) { errorEl.textContent = "Future dates not allowed."; return; }

        const amount = parseFloat(amountValue);
        if (isNaN(amount) || amount <= 0) { errorEl.textContent = "Amount must be positive."; return; }

        expenses.push({ id: Date.now(), date: dateValue, category, description, amount: Math.round(amount * 100) / 100 });
        saveExpenses(); form.reset(); initDateField(); refreshUI();
      });
    }

    function initViewSwitcher() {
      const viewButtons = document.querySelectorAll(".view-btn");
      const views = document.querySelectorAll(".view");
      viewButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.view;
          viewButtons.forEach((b) => b.classList.remove("active"));
          views.forEach((v) => v.classList.remove("active"));
          btn.classList.add("active"); document.getElementById(`view-${target}`).classList.add("active");
          if (target === "current") renderCurrentMonthView(); else if (target === "year") renderYearView();
        });
      });
    }

    function formatCurrency(amount) { return (amount || 0).toLocaleString("en-IN", { style: "currency", currency: "INR", minimumFractionDigits: 2 }); }
    function formatDateDisplay(dateStr) { const d = new Date(dateStr); return isNaN(d.getTime()) ? dateStr : d.toLocaleDateString("en-IN", { day: "2-digit", month: "short", year: "numeric" }); }
    function escapeHTML(str) { return str.replace(/[&<>'"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[c])); }
    function sumAmounts(arr) { return arr.reduce((sum, e) => sum + (e.amount || 0), 0); }
    function getCurrentYearExpenses() { return expenses.filter(exp => new Date(exp.date).getFullYear() === CURRENT_YEAR); }
    function getMonthlyExpenses(monthIndex) { return getCurrentYearExpenses().filter(exp => new Date(exp.date).getMonth() === monthIndex); }

    function buildCategoryDataset(expensesArray) {
      const totals = {}; expensesArray.forEach(exp => { if (!totals[exp.category]) totals[exp.category] = 0; totals[exp.category] += exp.amount; });
      const labels = Object.keys(totals);
      const data = labels.map(l => Math.round(totals[l] * 100) / 100);
      const colors = labels.map(l => CATEGORY_COLORS[l] || "rgba(148, 163, 184, 0.9)");
      return { labels, data, colors };
    }

    function refreshUI() { renderCurrentMonthView(); renderYearView(); }

    function renderCurrentMonthView() {
      const totalEl = document.getElementById("current-month-total-big");
      const labelEl = document.getElementById("current-month-label");
      const emptyEl = document.getElementById("current-month-empty");
      const canvas = document.getElementById("currentMonthPie");
      if (!totalEl) return;

      labelEl.textContent = new Date(CURRENT_YEAR, CURRENT_MONTH_INDEX, 1).toLocaleString("en-IN", { month: "long", year: "numeric" });
      const thisMonthExpenses = getMonthlyExpenses(CURRENT_MONTH_INDEX);
      totalEl.textContent = formatCurrency(sumAmounts(thisMonthExpenses));

      if (!thisMonthExpenses.length) { emptyEl.style.display = "flex"; if (currentMonthPieChart) { currentMonthPieChart.destroy(); currentMonthPieChart = null; } } 
      else {
        emptyEl.style.display = "none";
        const { labels, data, colors } = buildCategoryDataset(thisMonthExpenses);
        if (currentMonthPieChart) currentMonthPieChart.destroy();
        const ctx = canvas.getContext("2d");
        currentMonthPieChart = new Chart(ctx, { type: "doughnut", data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: "#020617", borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: "60%", plugins: { legend: { position: "bottom", labels: { color: "#e5e7eb", boxWidth: 14 } } } } });
      }
      renderCurrentMonthTable();
    }

    function renderCurrentMonthTable() {
      const tbody = document.getElementById("current-month-tbody");
      const subtitleEl = document.getElementById("current-month-table-subtitle");
      if (!tbody) return;
      tbody.innerHTML = "";
      const thisMonthExpenses = getMonthlyExpenses(CURRENT_MONTH_INDEX).sort((a, b) => new Date(b.date) - new Date(a.date));
      const monthLabel = new Date(CURRENT_YEAR, CURRENT_MONTH_INDEX, 1).toLocaleString("en-IN", { month: "long", year: "numeric" });

      if (!thisMonthExpenses.length) {
        subtitleEl.textContent = `No expenses yet in ${monthLabel}.`;
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:14px; color:#9ca3af;">No expenses this month.</td></tr>`;
        return;
      }
      subtitleEl.textContent = `Showing ${thisMonthExpenses.length} expense(s) in ${monthLabel}.`;
      thisMonthExpenses.forEach(exp => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><div>${formatDateDisplay(exp.date)}</div>${exp.description ? `<span class="expense-note">${escapeHTML(exp.description)}</span>` : ""}</td><td><span class="category-pill category-${exp.category.toLowerCase()}">${escapeHTML(exp.category)}</span></td><td class="amount-cell text-right">${formatCurrency(exp.amount)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function buildYearMonthCards() {
      const container = document.getElementById("year-months-container"); if (!container) return;
      container.innerHTML = "";
      for (let m = 0; m < 12; m++) {
        const monthLabel = new Date(CURRENT_YEAR, m, 1).toLocaleString("en-IN", { month: "long" });
        const card = document.createElement("div"); card.className = "card month-card";
        card.innerHTML = `<div class="month-card-header"><span class="month-chip">${monthLabel} ${CURRENT_YEAR}</span><span class="month-status" id="month-status-${m}"></span></div><div class="month-card-total" id="month-total-${m}">₹0.00</div><div class="month-card-sub">Total spent</div><div class="chart-wrapper small"><canvas id="month-pie-${m}"></canvas><div class="chart-empty" id="month-empty-${m}">No expenses.</div></div>`;
        container.appendChild(card);
      }
    }

    function renderYearView() {
      if (!yearViewBuilt) { buildYearMonthCards(); yearViewBuilt = true; }
      const yearExpenses = getCurrentYearExpenses();
      document.getElementById("year-total-amount").textContent = formatCurrency(sumAmounts(yearExpenses));
      
      let monthsWithExpenses = 0;
      for (let m = 0; m < 12; m++) {
        const monthExpenses = getMonthlyExpenses(m);
        if (monthExpenses.length > 0) monthsWithExpenses++;
        document.getElementById(`month-total-${m}`).textContent = formatCurrency(sumAmounts(monthExpenses));
        
        const statusEl = document.getElementById(`month-status-${m}`);
        const emptyEl = document.getElementById(`month-empty-${m}`);
        const canvas = document.getElementById(`month-pie-${m}`);

        if (m < CURRENT_MONTH_INDEX) statusEl.textContent = "Past";
        else if (m === CURRENT_MONTH_INDEX) statusEl.textContent = "Current";
        else statusEl.textContent = "Future";

        if (m > CURRENT_MONTH_INDEX || !monthExpenses.length) {
          emptyEl.style.display = "flex";
          if (monthPieCharts[m]) { monthPieCharts[m].destroy(); monthPieCharts[m] = null; }
          continue;
        }
        emptyEl.style.display = "none";
        const { labels, data, colors } = buildCategoryDataset(monthExpenses);
        if (monthPieCharts[m]) monthPieCharts[m].destroy();
        const ctx = canvas.getContext("2d");
        monthPieCharts[m] = new Chart(ctx, { type: "doughnut", data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: "#020617", borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: "60%", plugins: { legend: { display: false } } } });
      }
      document.getElementById("year-months-count").textContent = monthsWithExpenses;
      document.getElementById("year-avg-month").textContent = formatCurrency(monthsWithExpenses ? sumAmounts(yearExpenses) / monthsWithExpenses : 0);
    }
  </script>
</body>
</html>